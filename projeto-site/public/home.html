<!doctype html>
<html>

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="css/dashboart.css">
	<title>Dashboard</title>
	<script src="https://www.chartjs.org/dist/2.9.3/Chart.min.js"></script>
	<script src="https://www.chartjs.org/samples/latest/utils.js"></script>
	<script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
	<script type="text/javascript" src="funcoes.js"></script>
	<style>
		canvas {
			-moz-user-select: none;
			-webkit-user-select: none;
			-ms-user-select: none;
		}
	</style>
</head>

<body onload="atualizarGrafico();">
	<div class="sidebar" id="mySidebar">
		<a href="#" class="closebtn" onclick="closeNav()">x</a>
		<a href="home.html"><b id="b_usuario"></b></a>
		<a href="cadastroEmpresa.html">Cadastrar Empresa</a>
		<a href="cadastro.html">Cadastrar Usuário</a>
		<a href="#" onclick="logoff()">sair</a>
	</div>
	<div class="header">
		<a class="openbtn" onclick="openNav()"> ☰ </a>
	</div>
	<div id="main">
		<div class="alertas" id="alert">
			Ônibus 1
			<div class="conteudoAlert" id="alert1">
				<p>Quantidade de Passageiros</p> <span id="span1" class="span"></span>
			</div>
		</div>
		<div class="alertas">
			Ônibus 2
			<div class="conteudoAlert" id="alert2">
				<p>Quantidade de Passageiros</p> <span id="span2" class="span"></span>
			</div>
		</div>
		<div class="alertas">
			Ônibus 3
			<div class="conteudoAlert" id="alert3">
				<p>Quantidade de Passageiros</p> <span id="span3" class="span"></span>
			</div>
		</div>

		<div style="width:75%;">
			<div id="div_aguarde">Dados sendo obtidos...</div>
			<canvas id="canvas_grafico"></canvas>

		<div class="social">
			<h3>Alerta De Risco</h3>
			<img src="img/alertaRisco.png" alt="" class="alertaRisco">
		  </div>
		<footer>
			<p>Compartilhe O Sistema</p>
		</footer>

	
	</div>
	
</body>

</html>
<script src="js/menu.js"></script>
<script>
	function mudaCorAlert1(){
		let muda_alert1 = somatoria;
		span1.innerHTML = `${muda_alert1} Passageiros`;
		if(muda_alert1 <=20){
			alert1.style.backgroundColor = '#27AE60';
		}
		else if(muda_alert1 <=30){
			alert1.style.backgroundColor = '#F1C40F';
		}
		else if(muda_alert1 <=35){
			alert1.style.backgroundColor = '#fff714';
		}
		else {
			alert1.style.backgroundColor = '#E74C3C';
		}
	}
	function mudaCorAlert2(){
		let muda_alert2 =  parseInt(Math.random() * 40);
		span2.innerHTML = `${muda_alert2} Passageiros`;
		if(muda_alert2 <=20){
			alert2.style.backgroundColor = '#27AE60';
		}
		else if(muda_alert2 <=30){
			alert2.style.backgroundColor = '#F1C40F';
		}
		else if(muda_alert2 <=35){
			alert2.style.backgroundColor = '#fff714';
		}
		else {
			alert2.style.backgroundColor = '#E74C3C';
		}
	}
	function mudaCorAlert3(){
		let muda_alert3 =  parseInt(Math.random() * 40);
		span3.innerHTML = `${muda_alert3} Passageiros`;
		if(muda_alert3 <=20){
			alert3.style.backgroundColor = '#27AE60';
		}
		else if(muda_alert3 <=30){
			alert3.style.backgroundColor = '#F1C40F';
		}
		else if(muda_alert3 <=35){
			alert3.style.backgroundColor = '#fff714';
		}
		else {
			alert3.style.backgroundColor = '#E74C3C';
		}
	}
	setInterval(mudaCorAlert1, 3000);
	setInterval(mudaCorAlert2, 3000);
	setInterval(mudaCorAlert3, 3000);
	let somatoria = 0;
    window.onload = obterDadosGrafico;

    verificar_autenticacao();

    // neste JSON tem que ser 'labels', 'datasets' etc, 
    // porque é o padrão do Chart.js
    var dados = {
        labels: [],
        datasets: [
            {
                yAxisID: 'y-presenca',
                label: 'Passageiros',
                borderColor: window.chartColors.red,
                backgroundColor: window.chartColors.red,
                fill: false,
                data: []
            }
        ]
    };


    // só mexer se quiser alterar o tempo de atualização
    // ou se souber o que está fazendo!
    function atualizarGrafico() {

        fetch('/leituras/tempo-real', { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);

                    if (dados.labels.length == 10) {
                        dados.labels.shift();
                        dados.datasets[0].data.shift();
                    }
                    dados.labels.push(novoRegistro.momento);
					somatoria += novoRegistro.passageiros;
					
                    if (somatoria < 0) somatoria = 0;
                    dados.datasets[0].data.push(somatoria);
                    window.grafico_linha.update();

                    setTimeout(atualizarGrafico, 5000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                setTimeout(atualizarGrafico, 5000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    // altere aqui as configurações do gráfico
    // (tamanhos, cores, textos, etc)
    function configurarGrafico() {
        var configuracoes = {
            responsive: true,
            animation: { duration: 500 },
            hoverMode: 'index',
            stacked: false,
            title: {
                display: true,
                text: 'Histórico recente de Passageiros'
            },
            scales: {
                yAxes: [{
                    type: 'linear', // only linear but allow scale type registration. This allows extensions to exist solely for log scale for instance
                    display: true,
                    position: 'left',
                    id: 'y-presenca',
                }
                ],
            }
        };

        return configuracoes;
    }

    // altere aqui como os dados serão exibidos
    // e como são recuperados do BackEnd
    function obterDadosGrafico() {

        fetch('/leituras/ultimas', { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (registro) {

                    console.log(`Dados recebidos: ${JSON.stringify(registro)}`);

                    dados.labels.push(registro[0].momento_t1);


                    Object.keys(registro[0]).map(key => {
                        if (key.indexOf('passageiros') > -1) somatoria += registro[0][key];
                    });

                    dados.datasets[0].data.push(somatoria);

                    div_aguarde.style.display = 'none';

                    plotarGrafico(dados);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

    // só altere aqui se souber o que está fazendo!
    function plotarGrafico(dados) {
        console.log('iniciando plotagem do gráfico...');

        var ctx = canvas_grafico.getContext('2d');
        window.grafico_linha = Chart.Line(ctx, {
            data: dados,
            options: configurarGrafico()
        });

        setTimeout(atualizarGrafico, 5000);
    }

</script>